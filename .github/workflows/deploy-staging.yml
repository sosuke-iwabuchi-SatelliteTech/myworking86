name: Deploy Staging

on:
  push:
    branches:
      - develop
    paths:
      - 'app/**'
      - 'bootstrap/**'
      - 'config/**'
      - 'resources/**'
      - 'routes/**'

jobs:
  ci:
    uses: ./.github/workflows/ci.yml

  deploy:
    needs: ci
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.3'
          extensions: mbstring, xml, ctype, iconv, intl, pdo_sqlite, dom, filter, json
          coverage: none

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install Composer dependencies
        run: composer install --no-dev --optimize-autoloader --prefer-dist

      - name: Install NPM dependencies
        run: npm ci

      - name: Build
        env:
          VITE_GACHA_IMAGE_HOST: ${{ secrets.VITE_GACHA_IMAGE_HOST }}
        run: npm run build

      - name: Deploy via SCP
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: 22
          passphrase: ${{ secrets.SSH_PASSPHRASE }}
          source: "app,bootstrap,config,database/migrations,database/seeders,database/factories,public/build,public/textbook,public/index.php,public/.htaccess,public/*.png,public/*.svg,public/*.ico,public/*.json,public/*.txt,resources,routes,vendor,artisan,composer.json,composer.lock,vite.config.js,package.json"
          target: ${{ secrets.APP_ROUTE_PATH_STG }}

      - name: Execute remote commands
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: 22
          passphrase: ${{ secrets.SSH_PASSPHRASE }}
          script: |
            cd ${{ secrets.APP_ROUTE_PATH_STG }}
            chmod -R 775 storage database
            php artisan migrate --force
            php artisan db:seed --class=PrizeSeeder --force
            php artisan config:cache
            php artisan route:cache
            php artisan view:cache
