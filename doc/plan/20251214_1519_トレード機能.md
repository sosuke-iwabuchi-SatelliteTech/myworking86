# ガチャ景品交換機能 (Trade Feature) 実装計画案

## ユーザーレビュー要求事項
> [!NOTE]
> この計画は、ユーザー間で所持しているガチャ景品 (`UserPrize`) を交換可能にする機能の提案です。
> 具体的な仕様（フレンド限定にするか、誰とでも交換可能か、手数料の有無など）については、この基本設計を元に調整可能です。

## 概要
ユーザーが所持するアイテム（ガチャ景品）を他のユーザーと交換できる機能を提供します。
基本的には「ユーザーAがユーザーBを指定して交換を申し込む（または公開募集する）」形式を想定しますが、まずは**特定のユーザーを指定しての直接トレード（Direct Trade）**をベースに設計します。

## 提案する変更

### データベース設計
新しいテーブルを2つ導入し、トレードの状態と対象アイテムを管理します。

#### 1. `trade_requests` テーブル
トレード自体のステータスを管理します。

| Column | Type | Description |
|---|---|---|
| `id` | UUID | プライマリキー |
| `sender_id` | UUID | 申請者のUser ID |
| `receiver_id` | UUID | 受信者のUser ID (NULL許容: 公開募集の場合) |
| `status` | String | `pending` (申請中), `accepted` (成立), `rejected` (拒否), `cancelled` (取消), `completed` (完了) |
| `message` | Text | 申請メッセージ (任意) |
| `created_at` | DateTime | |
| `updated_at` | DateTime | |

#### 2. `trade_request_items` テーブル
トレードに含まれるアイテムを管理します。

| Column | Type | Description |
|---|---|---|
| `id` | UUID | プライマリキー |
| `trade_request_id` | UUID | 親のトレードID |
| `user_prize_id` | UUID | 対象の UserPrize ID |
| `owner_id` | UUID | アイテムの現在の所有者 (`sender_id` または `receiver_id`) |
| `type` | String | `offer` (申請者の提示物), `request` (欲しいもの - オプション) |

> [!IMPORTANT]
> `user_prizes` テーブルのレコードは、トレード申請中 (`status=pending`) の間、他のトレードに出せないようにロックする必要があります。
> 実装時は `user_prizes` 取得時に「現在アクティブなトレードに含まれていないか」をチェックするロジック、または `user_prizes` に `status` カラムを追加する検討が必要です。今回は既存テーブルへの影響を最小限にするため、**トレード作成時に重複チェックを行うロジック**で対応します。

---

### コンポーネント設計 (API)

#### `TradeController`

1.  **`POST /api/trades` (作成)**
    -   パラメータ: `receiver_id`, `offered_user_prize_ids[]`, `requested_user_prize_ids[]` (任意)
    -   処理:
        -   所有権の確認。
        -   対象アイテムが他のアクティブなトレードに含まれていないか確認。
        -   `trade_requests`, `trade_request_items` レコード作成。

2.  **`GET /api/trades` (一覧)**
    -   フィルタ: `sent` (自分から), `received` (相手から), `status`
    -   自分に関係するトレードを表示。

3.  **`GET /api/trades/{trade_id}` (詳細)**
    -   トレードの詳細とアイテム情報を表示。

4.  **`PUT /api/trades/{trade_id}/accept` (承認)**
    -   **重要**: ここでアイテムの所有権移転処理を行います。
    -   承認者（受信者）も、自分が提供するアイテム（`request` されたもの、または承認時に指定）を選択するフローにする場合、ここでアイテム指定を受け付けます（今回はシンプルに「申請時に指定された条件のみ」で承認する場合を想定）。
    -   トランザクション処理:
        -   `UserPrize` の `user_id` を互いに入れ替える。
        -   `status` を `completed` に更新。

5.  **`PUT /api/trades/{trade_id}/reject` / `cancel`**
    -   ステータスを更新し、アイテムのロック状態（論理的ロック）を解除。

---

## UI/UX フロー (QRコードを用いた対面トレード)

ユーザーの要望に合わせて、「QRコードを表示して読み取る」ことでトレードを開始するフローを追加します。

### 1. トレード開始フロー
1.  **ホスト (申請者)**: アプリ内の「トレード」メニューから「QRコードを表示」を選択。
    -   自身のUser IDを含むトレード申請用URL (例: `/trades/new?target_user_id={UUID}`) をQRコード化して画面に表示。
2.  **ゲスト (相手)**: 「QRコードをスキャン」を選択し、カメラを起動。
3.  **スキャン完了**: ホストのQRコードを読み取ると、自動的に「トレード申請画面」へ遷移。
    -   **申請先**: QRコードに含まれていたホストのユーザーに固定。
    -   **UI**: 「{User Name} さんとのトレード」と表示。

### 2. トレード申請画面
-   **自分の持ち物**: 自分の所持品 (`user_prizes`) から提供するアイテムを選択。
-   **相手の持ち物 (任意)**: 相手の公開プロフィールから「欲しいもの」を選択 (オプション)。
-   「申請を送る」ボタン押下で `POST /api/trades` をコール。

### 3. 受け入れフロー
-   ホスト側の端末に通知、またはトレード一覧画面に「新着オファー」が表示される。
-   内容を確認し、「承認 (Accept)」「拒否 (Reject)」を選択。

## その他検討事項
-   **QRコード生成**: Frontend (React) 側で `react-qr-code` 等のライブラリを使用して生成。
-   **QRコード読み取り**: Frontend (React) 側で `react-qr-reader` 等を使用して実装。PWA/Mobileブラウザでのカメラアクセス権限に注意。

---

## 検証計画

### 自動テスト (Feature/Unit Test)
1.  **正常系**:
    -   ユーザーAがユーザーBにアイテムXを提示して申請作成できること。
    -   ユーザーBが承認すると、アイテムXの `user_id` がBになり、アイテムYの `user_id` がAになること（交換成立）。
2.  **異常系**:
    -   所持していないアイテムでの申請がエラーになること。
    -   既に進行中のトレードに含まれるアイテムで、別のトレードを作成できないこと。
    -   存在しないユーザーへの申請。

### 手動検証
-   DBを確認しながらAPIを実行し、`user_prizes` テーブルの所有者が正しく書き換わるか確認。
