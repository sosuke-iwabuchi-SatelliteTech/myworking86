# 設計ドキュメント (Design Document)

## レベル選択フロー

ユーザーがプレイしたいレベルを選択する際の画面フローを、より直感的に分かりやすい2段階の方式に変更しました。

1.  **学年選択画面 (Grade Selection)**
    *   アプリ起動後、まず「1ねんせい」「2ねんせい」といった学年の一覧が表示されます。
2.  **単元選択画面 (Level Selection)**
    *   いずれかの学年を選択すると、その学年に含まれる単元（例：「たしざん・ひききざん」「九九」）の一覧画面に遷移します。
    *   「もどる」ボタンで学年選択画面に戻ることも可能です。

この変更により、将来的に単元が増えた場合でも、画面が煩雑になるのを防ぎます。

## データ構造

### レベル定義 (`src/constants.ts`)

レベルの定義を、学年ごとにグループ化された階層構造に変更しました。これにより、上記の2段階選択フローを効率的に実装しています。

**変更後のデータ構造 (`GRADES`)**:
```typescript
[
  {
    grade: 1,
    name: "1ねんせい",
    levels: [
      { id: "grade-1-calc", name: "たしざん・ひきざん" },
      // ...
    ]
  },
  // ...
]
```

### 履歴データ (`src/types.ts`)

プレイ履歴を保存する `HistoryRecord` 型に、プレイした学年を記録するための `grade` フィールド（オプショナル）を追加しました。

```typescript
export interface HistoryRecord {
  timestamp: number;
  score: number;
  level: GameLevel;
  time?: number;
  grade?: number; // 追加
}
```
これにより、履歴画面で学年ごとの成績をより分かりやすく表示できるようになりました。古いデータには `grade` がないため、その場合は学年表示が省略されます。

---

## 筆算パッド機能

暗算が難しい計算問題（例：2桁の掛け算）のために、計算の補助として使用できる筆算パッド機能を実装しました。

### 機能概要

*   **目的**: ユーザーが計算過程をメモするための補助的なツール。利用は任意です。
*   **対象問題**: 問題データに `showCalculationPad: true` フラグが設定されている問題でのみ表示されます。
*   **UI**:
    *   問題の右側に、計算式と3行x4列の入力マスが表示されます。
    *   画面下部には、数字（0-9）と「クリア」ボタンを備えたテンキーが表示されます。
*   **操作**:
    *   ユーザーは入力したいマスをクリックしてアクティブにし、テンキーで数字を入力します。
    *   「クリア」ボタンで入力内容をすべて消去できます。
*   **役割**:
    *   筆算パッドへの入力内容は正誤判定には影響せず、あくまでメモとして機能します。最終的な解答は、従来通り4つの選択肢から選択します。

### 実装

*   **コンポーネント**: `src/components/CalculationPad.tsx`
    *   再利用可能なコンポーネントとして実装。
*   **データ連携**: `QuizScreen.tsx`
    *   問題データ（`Question`型）の`showCalculationPad`フラグをチェックし、コンポーネントの表示を制御します。
    *   問題のテキスト（例: "78 x 45"）をパースし、計算対象の数値を`CalculationPad`コンポーネントに渡します。

---

## メダル獲得条件の変更について

本プロジェクトでは、ゲームの結果に応じて付与されるメダル（王冠）の獲得条件を以下の通り変更しました。
以前はタイムのみが条件でしたが、**スコアが100点（満点）であること**が必須条件となりました。

### 変更後の条件

| メダル種類 | 条件 |
| :--- | :--- |
| 🥇 金メダル (Gold) | **100点** かつ **タイムが20秒以内** |
| 🥈 銀メダル (Silver) | **100点** かつ **タイムが20秒より遅く、25秒以内** |

※ スコアが100点未満の場合、タイムがどれだけ速くてもメダルは付与されません。

## UI/UXの変更

### リザルト画面 (ResultScreen)

*   **メダル表示**: 条件を満たした場合、画面上部のトロフィー（🏆）アイコンの代わりに、獲得したメダル（🥇または🥈）を表示します。
*   **アニメーション**: メダル獲得の達成感を演出するため、メダル表示時に拡大縮小するアニメーション（`medal-anim`）を適用しています。

### 履歴画面 (HistoryScreen)

*   **メダル表示**: 各プレイ履歴のタイム表示の横に、獲得したメダルを表示します。
*   **条件反映**: リザルト画面と同様のロジックで判定を行い、条件を満たした記録にのみメダルを表示します。

## 実装詳細

### CSSアニメーション (`index.css`)

メダルを目立たせるために以下のキーフレームアニメーションを定義しました。

```css
@keyframes medalPulse {
  0% {
    transform: scale(0.5);
    opacity: 0;
  }
  60% {
    transform: scale(1.2);
    opacity: 1;
  }
  100% {
    transform: scale(1);
    opacity: 1;
  }
}
```

## 問題生成アーキテクチャ (Question Generation Architecture)

コードの保守性と拡張性を高めるため、問題生成ロジックを `QuizScreen.tsx` から切り出し、Strategyパターン（Factoryパターン）を用いてリファクタリングしました。

### 構造

*   **インターフェース**: `QuestionGenerator` (`src/questions/QuestionGenerator.ts`)
    *   `generate(): Question` メソッドを定義。
*   **ファクトリ**: `QuestionFactory` (`src/questions/QuestionFactory.ts`)
    *   ゲームレベル（`GameLevel`）を受け取り、適切な `QuestionGenerator` のインスタンスを返します。
*   **実装クラス** (`src/questions/`):
    *   `Grade1CalcGenerator`: 1年生のたし算・ひき算。
    *   `Grade2KukuGenerator`: 2年生の九九。
    *   `Grade4GeometryGenerator`: 4年生の図形の面積（長方形、三角形、台形）。
    *   `Grade4MultiplicationGenerator`: 4年生の2桁の掛け算。

### 各レベルの問題生成ロジック概要

1.  **1年生 計算 (Grade 1 Calc)**
    *   **たし算**: `(1-10) + (1-10)`
    *   **ひき算**: `(5-19) - (0-num1)` ※答えが負にならないように調整

2.  **2年生 九九 (Grade 2 Kuku)**
    *   `(1-9) × (1-9)`

3.  **4年生 図形 (Grade 4 Geometry)**
    *   **長方形**: `たて(2-9) × よこ(2-9)`
    *   **三角形**: `ていへん(2-9) × たかさ(2-9) ÷ 2`
        *   ※面積が整数になるように、底辺×高さが偶数になるよう調整。
    *   **台形**: `（じょうてい(2-7) ＋ かてい(upper + 2-6)）× たかさ(2-7) ÷ 2`
        *   ※面積が整数になるように、(上底+下底)×高さが偶数になるよう調整。

4.  **4年生 2桁の掛け算 (Grade 4 Multiplication)**
    * `(10-99) x (10-99)`
    * このレベルの問題では、筆算パッドが表示されます。
